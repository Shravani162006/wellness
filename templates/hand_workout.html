<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Hand Workout</title>

<!-- MediaPipe -->
<script src="https://cdn.jsdelivr.net/npm/@mediapipe/hands/hands.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@mediapipe/camera_utils/camera_utils.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@mediapipe/drawing_utils/drawing_utils.js"></script>


</head>

<body>

<h2>âœ‹ Hand Workout</h2>

<video id="inputVideo" autoplay playsinline></video>
<canvas id="outputCanvas"></canvas>

<div id="stats">
    <p>Reps: <strong id="repCount">0</strong></p>
    <p>Status: <span id="status">Waiting...</span></p>
</div>

<button onclick="saveProgress()">ðŸ’¾ Save Progress</button>
<button onclick="window.location.href='/exercise'">â¬… Back</button>

<script>
const videoElement = document.getElementById("inputVideo");
const canvasElement = document.getElementById("outputCanvas");
const canvasCtx = canvasElement.getContext("2d");

let repCount = 0;
let prevState = "open";

function isHandOpen(landmarks) {
    const tips = [8, 12, 16, 20];
    const mcps = [5, 9, 13, 17];

    let extended = 0;
    for (let i = 0; i < tips.length; i++) {
        if (landmarks[tips[i]].y < landmarks[mcps[i]].y) {
            extended++;
        }
    }
    return extended >= 3;
}

const hands = new Hands({
    locateFile: file =>
        `https://cdn.jsdelivr.net/npm/@mediapipe/hands/${file}`
});

hands.setOptions({
    maxNumHands: 1,
    modelComplexity: 1,
    minDetectionConfidence: 0.7,
    minTrackingConfidence: 0.7
});

hands.onResults(results => {
    canvasCtx.clearRect(0, 0, canvasElement.width, canvasElement.height);
    canvasCtx.drawImage(results.image, 0, 0, canvasElement.width, canvasElement.height);

    if (results.multiHandLandmarks && results.multiHandLandmarks.length > 0) {
        const landmarks = results.multiHandLandmarks[0];

        drawConnectors(canvasCtx, landmarks, HAND_CONNECTIONS, {color: '#00FF00', lineWidth: 4});
        drawLandmarks(canvasCtx, landmarks, {color: '#FF0000', lineWidth: 2});

        const open = isHandOpen(landmarks);
        const currentState = open ? "open" : "closed";

        document.getElementById("status").innerText = currentState;

        if (prevState === "closed" && currentState === "open") {
            repCount++;
            document.getElementById("repCount").innerText = repCount;
        }
        prevState = currentState;
    }
});

const camera = new Camera(videoElement, {
    onFrame: async () => {
        await hands.send({ image: videoElement });
    },
    width: 480,
    height: 360
});

camera.start();

function saveProgress() {
    fetch("/save_exercise_progress", {
        method: "POST",
        headers: {"Content-Type": "application/json"},
        body: JSON.stringify({
            exercise_type: "hand_workout",
            reps: repCount,
            date: new Date().toISOString().slice(0,16).replace("T"," ")
        })
    })
    .then(res => res.json())
    .then(() => alert("Progress saved successfully!"))
    .catch(() => alert("Error saving progress"));
}
</script>

</body>
</html>
