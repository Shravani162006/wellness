<!DOCTYPE html>
<html>
<head>
  <title>Exercise Tracker</title>

  <script src="https://cdn.jsdelivr.net/npm/@mediapipe/pose"></script>
  <script src="https://cdn.jsdelivr.net/npm/@mediapipe/camera_utils"></script>

</head>
<body>

<h2>{{ exercise_type|capitalize }}</h2>
<h1 id="count">0</h1>
<video id="video" style="display:none"></video>
<canvas id="canvas" width="640" height="480"></canvas>

<button onclick="save()">Save Workout</button>

<script>
let count = 0, state = "up";

const pose = new Pose({
  locateFile: file => `https://cdn.jsdelivr.net/npm/@mediapipe/pose/${file}`
});

pose.setOptions({
  modelComplexity: 1,
  minDetectionConfidence: 0.5,
  minTrackingConfidence: 0.5
});

pose.onResults(results => {
  if (!results.poseLandmarks) return;

  const a = results.poseLandmarks[11];
  const b = results.poseLandmarks[13];
  const c = results.poseLandmarks[15];

  const angle = Math.abs(
    Math.atan2(c.y - b.y, c.x - b.x) -
    Math.atan2(a.y - b.y, a.x - b.x)
  ) * 180 / Math.PI;

  if (angle < 90) state = "down";
  if (angle > 160 && state === "down") {
    count++;
    state = "up";
    document.getElementById("count").innerText = count;
  }
});

const camera = new Camera(document.getElementById("video"), {
  onFrame: async () => await pose.send({image: video}),
  width: 640,
  height: 480
});
camera.start();

function save(){
  fetch("/save_exercise_progress", {
    method:"POST",
    headers:{ "Content-Type":"application/json" },
    body: JSON.stringify({
      exercise:"{{ exercise_type }}",
      reps: count
    })
  }).then(()=>alert("Saved"));
}
</script>

</body>
</html>
